[pytest]
# Test discovery patterns
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Test paths
testpaths = tests

# Pytest options
# Default: Run fast core tests (unit tests without slow/comprehensive markers)
# Use -m "" to run all tests, or -m "comprehensive" for edge cases only
addopts =
    -ra
    --strict-markers
    --ignore=tests/archive/
    --ignore=tests/performance/
    --ignore=tests/test_real_services.py
    # Re-enabled observability and search tests for production readiness
    # --ignore=tests/test_observability.py
    # --ignore=tests/search/test_service.py
    # --ignore=tests/search/test_router.py

# Test timeouts to prevent hanging
# Global timeout: 5 minutes per test (prevents infinite hangs)
# E2E tests get longer timeout (10 minutes)
# Install: pip install pytest-timeout
timeout = 300
timeout_func_only = true

# Markers for test categorization
# Run specific categories: pytest -m unit, pytest -m comprehensive, etc.
markers =
    unit: Fast unit tests (<0.1s) - default execution
    integration: Integration tests requiring external services (medium, <1s)
    slow: Slow running tests (>1s) - excluded from default runs
    comprehensive: Comprehensive edge case tests - optional validation
    skip: Skip test temporarily
    auth: Authentication and authorization tests
    secrets: Secrets management tests
    performance: Performance and load tests (excluded by default)
    benchmark: Performance benchmark tests
    e2e: End-to-end workflow tests
    observability: Observability and telemetry tests
    chaos: Chaos engineering tests
    contract: API contract tests
    serial: Tests that must run sequentially (not in parallel with pytest-xdist)
    serial_only: Database-heavy tests requiring serial execution (prevents connection pool exhaustion)
    parallel_safe: Tests safe for parallel execution with -n auto
    infra: Infrastructure smoke tests (Docker Compose, networking, service wiring)

# Test Execution Strategies:
#   Fast CI (default):     pytest tests/
#   Comprehensive CI:      pytest tests/ -m "comprehensive"
#   Integration tests:     pytest tests/ -m "integration"
#   Full suite:            pytest tests/ -m ""
#   Module-specific:       pytest tests/billing/ -v
#   Parallel execution:    pytest tests/ -n auto
#   Parallel integration:  pytest tests/ -m "integration" -n auto --dist loadgroup
#   Serial DB tests:       pytest tests/ -m "integration and serial_only"
#   Parallel-safe tests:   pytest tests/ -m "integration and parallel_safe" -n auto

# Asyncio - auto mode for better compatibility
asyncio_mode = auto

# pytest-xdist configuration for parallel test execution
# Use -n auto to automatically detect CPU cores
# Use --dist loadgroup to keep tests from same file in same worker (better for integration tests)
# Tests marked with @pytest.mark.serial will run sequentially

# Filter warnings
filterwarnings =
    error::RuntimeWarning
    ignore::DeprecationWarning
    ignore::pytest.PytestUnraisableExceptionWarning
    ignore::UserWarning

# Logging
log_cli = false
log_cli_level = INFO

# Coverage configuration
# Use --cov flag when needed
# Overall target: 80% coverage
# Module-specific targets:
#   auth: 85%, billing: 80%, communications: 75%
#   data_transfer: 80%, customer_management: 75%
#   webhooks: 75%, search: 70%, monitoring: 70%
